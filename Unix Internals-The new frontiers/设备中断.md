# [设备中断]
设备通过中断获得关注。许多unix系统定义了一组中断优先级别，这些级别在每个系统中不尽相同。最低的中断优先级别是0，但是事实上所有的用户代码以及大多数普通的内核代码运行在该级别上。最高的中断优先级别依赖于具体实现，一些公共的级别包括：6,7,15和31。如果一个中断的级别比当前的系统中断级别低，那么它将阻塞直到当前系统中断级别低于这个未决的中断，这样使系统可以按照不同中断类型区分优先次序。

每个设备中断都有确定的中断优先级别，一般而言，基于同一个控制器的所有设备都有同样的中断优先级别。当内核处理一个中断时，它首先将系统的中断优先级别设为该中断的优先级别，然后阻塞该设备上的其他中断(以及相同或较低优先级别的中断)。此外，一些内核例程会暂时提升中断优先级别以阻塞某些中断。

通常所有的中断会调用一个内核中通用的中断例程，并传递一些识别中断的信息。这个例程包含三个步骤：1.保存寄存器上下文；2.提升系统的中断优先级别为该中断的级别；3.调用中断处理程序。当中断处理完成后，它将控制权返回给通用的中断例程，通用中断例程负责恢复之前的中断优先级别、恢复保存的寄存器上下文以及从中断返回。

内核识别正确的中断处理程序依赖于系统是否支持向量中断或轮询中断。在一个向量中断系统中，每种设备提供一个唯一的中断向量号，这个向量号是中断向量表的索引。在这个表中的表项指向对应的中断处理程序。

对于一些系统，中断可能仅提供中断优先级，或者，中断提供一个可能被多个设备映射的向量。内核维护了一个共享相同中断优先级别(或相同向量)的中断处理程序链表。当一个中断被触发时，通用中断例程循环迭代链表并且轮询每个驱动。驱动程序依次检查该中断是否是自己负责的设备产生的，如果确实是，它处理这个中断，然后返回给通用中断例程一个成功的状态，如果不是，那么它将返回一个错误的状态，通用中断例程将继续轮询下一个设备。

系统可以将这两种方法结合起来使用。支持向量中断的系统可以通过链表使用中断处理程序，这样可以简单地在运行的系统中动态加载设备驱动，同时可以允许厂商开发定制的驱动，并将其放置在链表的前端。这样的定制驱动位于设备与默认的驱动程序之间，它可以选择性地陷入并处理一些中断，其余的中断交于默认驱动处理。

中断处理程序是系统中非常重要的任务，它的执行优先于任何用户或系统进程。由于中断处理程序中断了其他所有的活动(除了高优先级中断)，它必须非常迅速，因此在大多数unix系统的实现不允许中断处理程序处于睡眠状态。如果中断处理程序需要一个被锁住的资源，那么它必须尽量通过非阻塞的方式获得。这些原因改变了中断处理程序必须要做的工作。一方面，中断处理程序必须短小快速，并且其处理工作要尽可能少。另外一方面，它必须做足够的工作以保证在重负载的情况下设备不会空闲。比如，当磁盘的输入输出操作完成时，磁盘驱动出发了系统中断，中断处理程序需要通知内核操作的结果，同时在还有未决请求的情形下必须启动下一个输入输出操作。否则，直到内核重新获得控制权并开始下一个请求时磁盘将一直处于空闲状态。
